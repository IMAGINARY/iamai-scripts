#!/bin/bash
# This wrapper script is supposed to be visible in ps -a resp. ps -u `id -u` to make
# it easy to kill it (by a script or manually)

PIDS=""
function finish {
    EXIT_CODE=$?
    kill $PIDS >/dev/null 2>&1
    exit $EXIT_CODE
}
trap finish SIGINT SIGTERM EXIT

# Create the config file if it does not exist
INSTALL_DIR="/opt/gradient-descent"
CONFIG_FILE="${INSTALL_DIR}/config.iamai.local.json"
[ -f "$CONFIG_FILE" ] || cat >"${CONFIG_FILE}" <<EOL
{
  "defaultLanguage": "en",
  "useGamepads": true,
  "useScreenControls": false,
  "useKeyboardControls": true,
  "botType": null,
  "botTypeLabels": "difficulty",
  "maxPlayers": 2,
  "maxTime": 120,
  "maxProbes": 10,
  "continuousGame": false,
  "showSeaFloor": false,
  "maxDepthTilt": 4,
  "fullScreenButton": false,
  "debugControls": false,
  "map": null
}
EOL

# Launch the exhibit in the background
kiosk-browser $KIOSK_OPTS \
    --kiosk \
    --fullscreen \
    --hide-scrollbars \
    --reload-idle "$(( 3 * 60 ))" \
    --reload-unresponsive 60 \
    --serve "${INSTALL_DIR}" \
    index.html?config=config.iamai.local.json &
PID_UI=$!
PIDS="$PIDS $PID_UI"

# Wait for the exhibit to finish or until the signal trap is triggered
wait $PID_UI
