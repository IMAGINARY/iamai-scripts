#!/usr/bin/env bash

# For some yet unknown reason, PulseAudio does not play audio when applications
# are launched too early during the startup process. It also seems to happen
# only for some sound cards, not all (e.g. it failed with the built-in card).
# Suspending PulseAudio and unsuspending it after some delay seems to work 
# around the issue. However the workaround includes a race condition, because
# there is no way to tell how long the delay actually needds to be to work in
# all cases. I went with twice the minimum delay that worked, just to be more
# on the safe side ¯\_(ツ)_/¯.
# At some point, this question may be answered here:
# https://answers.launchpad.net/ubuntu/+question/703840
PA_UNSUSPEND_DELAY=5
(pacmd suspend true; sleep "$PA_UNSUSPEND_DELAY"; pacmd suspend false) &

OUTPUTS=$(xrandr | grep " connected " | sed 's/ .*$//')

APP_OUTPUT_DEFAULT=$(echo "$OUTPUTS" | sed "1q;d")
MENU_OUTPUT_DEFAULT=$(echo "$OUTPUTS" | sed "2q;d")
MIDI_VIZ_OUTPUT_DEFAULT=$(echo "$OUTPUTS" | sed "3q;d")
TOUCH_DEVICE_NAME_DEFAULT=$(udevadm info --export-db | awk '/ID_INPUT_TOUCHSCREEN=1/' RS= | grep "^E: NAME=" | cut -d '"' -f2 | head -n 1)

MENU_OUTPUT="${CON_ESPRESSIONE_MENU_OUTPUT:-$MENU_OUTPUT_DEFAULT}"
APP_OUTPUT="${CON_ESPRESSIONE_APP_OUTPUT:-$APP_OUTPUT_DEFAULT}"
MIDI_VIZ_OUTPUT="${CON_ESPRESSIONE_MIDI_VIZ_OUTPUT:-$MIDI_VIZ_OUTPUT_DEFAULT}"
TOUCH_DEVICE_NAME="${CON_ESPRESSIONE_TOUCH_DEVICE_NAME:-$TOUCH_DEVICE_NAME_DEFAULT}"


if [[ -z "${CON_ESPRESSIONE_MENU_OUTPUT}" ]]; then
  echo "CON_ESPRESSIONE_MENU_OUTPUT environment variable not set. Using default value: ${MENU_OUTPUT}"
else
  echo "Using CON_ESPRESSIONE_MENU_OUTPUT environment variable. Value: ${MENU_OUTPUT}"
fi

if [[ -z "${CON_ESPRESSIONE_APP_OUTPUT}" ]]; then
  echo "CON_ESPRESSIONE_APP_OUTPUT environment variable not set. Using default value: ${APP_OUTPUT}"
else
  echo "Using CON_ESPRESSIONE_APP_OUTPUT environment variable. Value: ${APP_OUTPUT}"
fi

if [[ -z "${CON_ESPRESSIONE_MIDI_VIZ_OUTPUT}" ]]; then
  echo "CON_ESPRESSIONE_MIDI_VIZ_OUTPUT environment variable not set. Using default value: ${MIDI_VIZ_OUTPUT}"
else
  echo "Using CON_ESPRESSIONE_MIDI_VIZ_OUTPUT environment variable. Value: ${MIDI_VIZ_OUTPUT}"
fi

if [[ -z "${CON_ESPRESSIONE_TOUCH_DEVICE_NAME}" ]]; then
  echo "CON_ESPRESSIONE_TOUCH_DEVICE_NAME environment variable not set. Using default value: ${TOUCH_DEVICE_NAME}"
else
  echo "Using CON_ESPRESSIONE_TOUCH_DEVICE_NAME environment variable. Value: ${TOUCH_DEVICE_NAME}"
fi

xrandr --output "$APP_OUTPUT" --primary --auto
xrandr --output "$MENU_OUTPUT" --auto --right-of "$APP_OUTPUT"
xrandr --output "$MIDI_VIZ_OUTPUT" --auto --right-of "$MIDI_VIZ_OUTPUT"
TOUCH_DEVICE_ID=$(xinput list --id-only "$TOUCH_DEVICE_NAME")
xinput map-to-output "$TOUCH_DEVICE_ID" "$MENU_OUTPUT"

exit 0
