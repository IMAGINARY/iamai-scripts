#!/usr/bin/bash

# Adjust the GRADIENT_DESCENT_JS0_SYS_PATH and GRADIENT_DESCENT_JS1_SYS_PATH
# environment variables to match the (USB) ports on your machine.
#
# The path in sysfs can be found using
# `readlink -f /sys/class/input/js*/device/device`
# while the joysticks/gamepads are attached.
#
# By default, the devices are rebound in alphabetical order of their sysfs
# device path derived from `readlink -f /sys/class/input/js*/device/device`.

echo "The following joysticks/gamepads are present in the system:"
DEVICES=$(readlink -f /sys/class/input/js*/device/device | sort)
echo "$DEVICES"
echo

JS0_PATH_DEFAULT=$(echo "$DEVICES" | sed "1q;d")
JS1_PATH_DEFAULT=$(echo "$DEVICES" | sed "2q;d")

JS0_PATH=$(readlink -f "${GRADIENT_DESCENT_JS0_SYS_PATH:-$JS0_PATH_DEFAULT}")
JS0_ID=$(basename "$JS0_PATH")
JS0_DRV=$(readlink -f "$JS0_PATH/driver")
JS1_PATH=$(readlink -f "${GRADIENT_DESCENT_JS1_SYS_PATH:-$JS1_PATH_DEFAULT}")
JS1_ID=$(basename "$JS1_PATH")
JS1_DRV=$(readlink -f "$JS1_PATH/driver")

if [[ -z "${GRADIENT_DESCENT_JS0_SYS_PATH}" ]]; then
  echo "GRADIENT_DESCENT_JS0_SYS_PATH environment variable unset. Using default value: ${JS0_PATH}"
else
  echo "Using GRADIENT_DESCENT_JS0_SYS_PATH environment variable. Value: ${JS0_PATH}"
fi

if [[ -z "${GRADIENT_DESCENT_JS1_SYS_PATH}" ]]; then
  echo "GRADIENT_DESCENT_JS1_SYS_PATH environment variable unset. Using default value: ${JS1_PATH}"
else
  echo "Using GRADIENT_DESCENT_JS1_SYS_PATH environment variable. Value: ${JS1_PATH}"
fi


echo "Unbinding all joysticks ..."
find /sys/class/input/ -name 'js*' -print0 | while read -r -d '' js
do
  echo "  Unbinding $js"
  DEVICE_JS="$(readlink -f "$js/device")"
  DEVICE_INPUT="$(echo "$DEVICE_JS" | sed "s|/input/.*$||")"
  DEVICE_INPUT_ID="$(basename "$DEVICE_INPUT")"
  echo "$DEVICE_INPUT_ID" > "$DEVICE_INPUT/driver/unbind"
done
# Wait a bit for the devices to unbound
sleep 1

# Rebind the joysticks in the order we want them to appear in /dev/input/
echo "Re-binding the USB devices ..."

echo "  Binding $JS0_ID"
echo "$JS0_ID" > "$JS0_DRV/bind"
sleep 1

echo "  Binding $JS1_ID"
echo "$JS1_ID" > "$JS1_DRV/bind"
sleep 1

echo 
echo "  /dev/input/js0 now belongs to $(readlink -f "/sys/class/input/js0")"
echo "  /dev/input/js1 now belongs to $(readlink -f "/sys/class/input/js1")"
