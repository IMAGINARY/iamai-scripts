#!/usr/bin/env bash

if [ "$UID" -ne 0 ]
then
    >&2 echo "This script requires superuser priviledges."
    exit 1
fi

# cd into script directory
cd "$(dirname -- "$0")"

# retrieve files via git
DIR="/opt/kiosk-scripts"
BRANCH="wip"
mkdir -p "$DIR"
pushd "$DIR"
git init
git checkout "$BRANCH" || git checkout -b "$BRANCH"

if [[ `git status --porcelain` ]]; then
    git reset --hard
    echo "There were local changes. Re-running ..."
    popd
    exec "$0" "$@"
else
    # no local changes, check remote changes
    git remote remove origin &> /dev/null || true
    git remote add origin https://github.com/IMAGINARY/iamai-scripts.git
    git fetch --tags origin

    LOCAL_SHA=$(git rev-parse "$BRANCH")
    REMOTE_SHA=$(git rev-parse "origin/$BRANCH")

    if [ ! "$LOCAL_SHA" = "$REMOTE_SHA" ]; then
        git reset --hard "origin/$BRANCH"
        git checkout "origin/$BRANCH"
        echo "There were remote changes. Re-running ..."
        popd
        exec "$0" "$@"
    fi
fi

echo "kiosk-scripts files up to date. Running scripts ..."

popd

# sync the rootfs
rsync -va --info=ALL --exclude ".gitkeep" "$DIR/rootfs/" /

# disable the network time synchronization (time should be set via BIOS)
# systemctl disable systemd-timesyncd.service

# enable timer to automatically power-off the station
# systemctl daemon-reload
# systemctl reenable --now systemd-poweroff.timer
# systemctl start systemd-poweroff.timer

# modify configuration files on the host
./bin/internal/modify-os-cfg

# disable checking for updates, auto updates, upgrades and notifications
./bin/internal/disable-auto-updates
systemctl disable apt-daily.service apt-daily-upgrade.service
systemctl disable apt-daily.timer apt-daily-upgrade.timer

# update dconf setting based on rsynced config files
dconf update

# update grub menu
update-grub
