#!/usr/bin/env bash

if [ "$UID" -ne 0 ]
then
    >&2 echo "This script requires superuser priviledges."
    exit 1
fi

set -e

# cd into script directory
cd "$(dirname -- "$0")"

# retrieve files via git
DIR="/opt/kiosk-scripts"
BRANCH="wip"
mkdir -p "$DIR"
pushd "$DIR"
git init
git checkout "$BRANCH" || git checkout -b "$BRANCH"

if [[ `git status --porcelain` ]]; then
    git reset --hard
    echo "There were local changes. Re-running ..."
    popd
    exec "$0" "$@"
else
    # no local changes, check remote changes
    git remote remove origin &> /dev/null || true
    git remote add origin https://github.com/IMAGINARY/iamai-scripts.git
    git fetch --tags origin

    LOCAL_SHA=$(git rev-parse "$BRANCH")
    REMOTE_SHA=$(git rev-parse "origin/$BRANCH")

    if [ ! "$LOCAL_SHA" = "$REMOTE_SHA" ]; then
        git reset --hard "origin/$BRANCH"
        git checkout "origin/$BRANCH"
        echo "There were remote changes. Re-running ..."
        popd
        exec "$0" "$@"
    fi
fi

echo "kiosk-scripts files up to date. Running scripts ..."

popd
../internal/install-kiosk-scripts-local
